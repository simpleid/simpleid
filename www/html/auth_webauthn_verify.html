<script src="{{ @base_path }}html/assets/webauthn.js" type="text/javascript"></script>
<script type="text/javascript">
    document.addEventListener('alpine:init', () => {
        Alpine.data('getCredentialApp', (options, useType) => ({
            supported: document.isPublicKeyCredentialSupported(),
            challenge: '',
            nonce: '',
            result: '',
            url: options.url,
            tk: options.tk,
            baseRequestOptions: options.baseRequestOptions,
            useType: useType,
            isRequesting: false,
            error_message: null,

            async getCredential() {
                const challengeResponse = await fetch(this.url, { method: 'POST', headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-Request-Token': this.tk,
                    'Accept': 'application/json'
                }});
                if (!challengeResponse.ok) {
                    this.error_message = simpleid.intl.challenge_error;
                    return;
                }

                const challengeObject = await challengeResponse.json();
                this.challenge = challengeObject.challenge;
                this.nonce = challengeObject.nonce;

                const options = JSON.parse(JSON.stringify(this.baseRequestOptions)); // deep clone
                options.publicKey.challenge = challengeObject.challenge;

                this.isRequesting = true;
                this.error_message = null;
                await this.$nextTick();

                try {
                    const response = await webAuthnGetPublicKeyCredential(options);
                    this.result = JSON.stringify(response);

                    await this.$nextTick();
                    if (this.useType == 'passkey') {
                        // submitFormWithOp is defined in the parent Alpine component (auth_login.html)
                        this.submitFormWithOp('auth_passkey');
                    } else if (this.useType == 'verify') {
                        this.$refs.getCredentialButton.form.requestSubmit();
                    }
                } catch (e) {
                    this.isRequesting = false;

                    if (e.name == 'NotAllowedError') {
                        this.error_message = simpleid.intl.browser_error;
                    }
                    console.error(e.name);
                }
            }
        }));
    });
</script>

<check if="{{ @webauthn_use == 'verify' }}">
    <div class="narrative">
        <p>{{ @intl.core.auth_webauthn.webauthn_instructions_label }}</p>

        <p>{{ @intl.core.auth_webauthn.webauthn_recovery_label, @otp_recovery_url | format, raw }}</p>
    </div>
</check>

<div class="form-item" x-data="getCredentialApp({{ @request_credential_app_options | js, raw }}, {{ @webauthn_use | js, raw }})">
    <input type="hidden" name="webauthn[challenge]" x-model="challenge">
    <input type="hidden" name="webauthn[nonce]" x-model="nonce">
    <input type="hidden" name="webauthn[result]" x-model="result">

    <template x-if="!supported"><p>{{ @intl.core.auth_webauthn.webauthn_not_supported }}</p></template>

    <template x-if="error_message"><div class="message" x-text="error_message"></div></template>

    <div <check if="{{ @webauthn_use == 'passkey' }}">class="form-button-group"</check>>
        <button class="<check if="{{ @webauthn_use == 'verify' }}">is-default</check>" :disabled="isRequesting" @click.prevent="getCredential" x-show="supported" x-ref="getCredentialButton">
            <check if="{{ @webauthn_use == 'passkey' }}"><true>{{ @intl.core.auth_webauthn.login_block_title }}</true><false>{{ @intl.common.continue }}</false></check>
        </button>
    </div>
</div>

<check if="{{ (@webauthn_use == 'verify') && @@allow_remember }}">
    <div class="form-item">
        <label class="option">
            <input type="checkbox" name="webauthn[remember]" value="1" <check if="{{ @@REQUEST.webauthn.remember }}">checked="checked"</check>>
            {{ @intl.core.auth_webauthn.webauthn_remember_label }}
        </label>
    </div>
</check>
