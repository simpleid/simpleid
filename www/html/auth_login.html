<script type="text/javascript">
    document.addEventListener('alpine:init', () => {
        Alpine.data('createLoginApp', (options) => ({
            fs: options.fs,
            tk: options.tk,
            isSubmitted: false,
            showPasswordRegion: false,
            mode: options.mode,
            identifyUrl: options.identifyUrl,
            activeBlock: options.activeBlock,
            blocks: options.blocks,

            formReady($div) {
                const focus = new Array();
                $div.querySelectorAll('input[data-focus-weight]').forEach((el) => {
                    if ((el.value == '') && el.hasAttribute('data-focus-weight')) {
                        focus.push({ weight: el.getAttribute('data-focus-weight'), el: el });
                    }
                });
                if (focus.length == 0) return;
                focus.sort((a, b) => a.weight - b.weight);
                focus[0].el.focus();
            },

            submitFormWithOp(op) {
                this.$refs.form.insertAdjacentHTML('beforeend', `<input type="hidden" name="op" value="${op}">`);
                this.$refs.form.submit();
            },

            promptForPassword() {
                this.showPasswordRegion = true;
                this.isSubmitted = false;
                this.activeBlock = this.$el.querySelector('.login-block-region--password > .login-block')?.getAttribute('data-block-id');
                this.$nextTick(() => (this.$el.querySelectorAll('input.credentials')[0].focus()));
            },

            async formSubmit() {
                const evt = this.$event;
                this.isSubmitted = true;
                
                if ((this.mode == 0) && ('uid' in this.$refs) && (this.$refs.uid.value.trim() != '')) {
                    evt.preventDefault();
                    const formData = new URLSearchParams(new FormData(this.$refs.form));

                    const identifyResponse = await fetch(this.identifyUrl, { method: 'POST', headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-Request-Token': this.tk,
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Accept': 'application/json'
                    }, body: formData});

                    if (!identifyResponse.ok) {
                        // Show the password region if error occurs
                        this.promptForPassword();
                        return;
                    }

                    const result = await identifyResponse.json();

                    this.fs = result.fs;
                    this.tk = result.tk;
                    this.mode = result.mode;

                    if (result.action == 'request_password') {
                        this.promptForPassword();
                    } else if (request.action == 'show_credentials_form') {
                        this.$nextTick(() => this.submitFormWithOp('show_credentials_form')); 
                    }
                }
            },

            init() {
                this.$nextTick(() => this.formReady(this.$el));
            }
        }));
    });
</script>

<div class="login-security {{ @@security_class }}" x-data="createLoginApp({{ @login_app_options | js, raw }})">
    <form action="{{ @base_path }}auth/login/{{ @@destination }}" method="post" enctype="application/x-www-form-urlencoded"  @submit="formSubmit()" x-ref="form">
        <input type="hidden" name="fs" x-model="fs">
        <input type="hidden" name="tk" x-model="tk">
        <input type="hidden" name="active_block" x-model="activeBlock">

        <check if="{{ @@forms.identity }}">
            <div class="login-block-region login-block-region--identity">
                <repeat group="{{ @forms.identity }}" value="{{ @form }}">
                    <div class="login-block login-block--{{ @form.id }}" data-block-id="{{ @form.id }}">{{ @form.content | raw }}</div>
                </repeat>
            </div>
        </check>

        <check if="{{ @@forms.password }}">
            <div class="login-block-region login-block-region--password" x-show="showPasswordRegion" x-transition x-cloak>
                <repeat group="{{ @forms.password }}" value="{{ @form }}">
                    <div class="login-block login-block--{{ @form.id }}" data-block-id="{{ @form.id }}">{{ @form.content | raw }}</div>
                </repeat>
            </div>
        </check>

        <check if="{{ @@forms.default }}">
            <div class="login-block-region login-block-region--default">
                <repeat group="{{ @forms.default }}" value="{{ @form }}">
                    <div class="login-block login-block--{{ @form.id }}" data-block-id="{{ @form.id }}" <check if="{{ @@switchable || false }}">x-show="activeBlock == {{ @form.id | js, raw }}" x-cloak</check>>{{ @form.content | raw }}</div>
                </repeat>
            </div>
        </check>

        <check if="{{ @@forms.options }}">
            <div class="login-block-region login-block-region--options">
                <repeat group="{{ @forms.options }}" value="{{ @form }}">
                    <div class="login-block login-block--{{ @form.id }}" data-block-id="{{ @form.id }}">{{ @form.content | raw }}</div>
                </repeat>
            </div>
        </check>

        {* @submit_button text may vary depending on auth module *}
        {* value="submit" is not submitted in form data, whereas other values for the 'values' attribute are *}
        <button type="submit" class="is-default" id="auth-login-submit-button" x-show="activeBlock != null && blocks[activeBlock].showSubmitButton !== undefined ? blocks[activeBlock].showSubmitButton : true" :disabled="isSubmitted">{{ @@submit_button }}</button>
        
        <check if="{{ @@cancellable }}">
            <button type="submit" name="op" value="cancel" id="auth-login-cancel-button">{{ @intl.common.cancel }}</button>
        </check>

        <check if="{{ @@show_divider }}"><div class="form-item form-divider">{{ @intl.core.auth.divider_label }}</div></check>

        <check if="{{ @@forms.default && (@@switchable || false) }}">
            <div class="login-block-region login-block-region--alternative">
                <repeat group="{{ @forms.default }}" value="{{ @form }}">
                    <div class="form-item login-block-alternative--{{ @form.id }}" data-block-id="{{ @form.id }}"><a href="#" class="action-link" @click.prevent="activeBlock = {{ @form.id | js, raw }}" x-show="activeBlock != {{ @form.id | js, raw }}" x-cloak>{{ @@form.additional.title }}</a></div>
                </repeat>
            </div>
        </check>

        <check if="{{ @@forms.secondary }}">
            <div class="login-block-region login-block-region--after-buttons">
                <repeat group="{{ @@forms.secondary }}" value="{{ @form }}">
                    <div class="login-block login-block--{{ @form.id }}" data-block-id="{{ @form.id }}">{{ @form.content | raw }}</div>
                </repeat>
            </div>
        </check>
    </form>
</div>
